<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:AkademiTrack.ViewModels"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="500" d:DesignHeight="650"
        x:Class="AkademiTrack.Views.PrivacyPolicyWindow"
        x:DataType="vm:PrivacyPolicyWindowViewModel"
        Icon="/Assets/AT-Transparrent.png"
        Title="Godkjenn avtaler - AkademiTrack"
        Background="#F8F9FA"
        Height="700"
        Width="500"
        MinWidth="500"
        MinHeight="600"
        MaxHeight="750"
        WindowStartupLocation="CenterScreen"
        CanResize="true">

	<Window.Styles>
		<!-- Force all buttons to always be visible -->
		<Style Selector="Button">
			<Setter Property="IsVisible" Value="True"/>
			<Setter Property="Focusable" Value="True"/>
		</Style>

		<Style Selector="Button:disabled">
			<Setter Property="IsVisible" Value="True"/>
		</Style>

		<!-- Remove focus outlines globally -->
		<Style Selector="Button:focus /template/ Border">
			<Setter Property="BorderBrush" Value="Transparent"/>
			<Setter Property="BorderThickness" Value="0"/>
		</Style>

		<Style Selector="Button:focus-visible /template/ Border">
			<Setter Property="BorderBrush" Value="Transparent"/>
			<Setter Property="BorderThickness" Value="0"/>
		</Style>

		<!-- Primary Button Style -->
		<Style Selector="Button.primary">
			<Setter Property="Background" Value="#007ACC"/>
			<Setter Property="Foreground" Value="White"/>
			<Setter Property="FontWeight" Value="SemiBold"/>
			<Setter Property="CornerRadius" Value="6"/>
			<Setter Property="Padding" Value="24,14"/>
			<Setter Property="BorderThickness" Value="0"/>
			<Setter Property="BorderBrush" Value="Transparent"/>
			<Setter Property="FontSize" Value="15"/>
			<Setter Property="MinWidth" Value="160"/>
			<Setter Property="IsVisible" Value="True"/>
			<Setter Property="Template">
				<ControlTemplate>
					<Border Name="PART_Border"
							Background="{TemplateBinding Background}"
							CornerRadius="{TemplateBinding CornerRadius}"
							Padding="{TemplateBinding Padding}"
							BorderThickness="0"
							BorderBrush="Transparent">
						<ContentPresenter Name="PART_ContentPresenter"
										Content="{TemplateBinding Content}"
										HorizontalAlignment="Center"
										VerticalAlignment="Center"
										TextBlock.Foreground="{TemplateBinding Foreground}"
										TextBlock.FontWeight="{TemplateBinding FontWeight}"
										TextBlock.FontSize="{TemplateBinding FontSize}"
										TextBlock.TextAlignment="Center"/>
					</Border>
				</ControlTemplate>
			</Setter>
		</Style>

		<Style Selector="Button.primary:pointerover /template/ Border#PART_Border">
			<Setter Property="Background" Value="#005A9E"/>
			<Setter Property="BorderThickness" Value="0"/>
			<Setter Property="BorderBrush" Value="Transparent"/>
		</Style>

		<Style Selector="Button.primary:focus /template/ Border#PART_Border">
			<Setter Property="BorderThickness" Value="0"/>
			<Setter Property="BorderBrush" Value="Transparent"/>
		</Style>

		<Style Selector="Button.primary:disabled /template/ Border#PART_Border">
			<Setter Property="Background" Value="#CCCCCC"/>
			<Setter Property="BorderThickness" Value="0"/>
			<Setter Property="BorderBrush" Value="Transparent"/>
		</Style>

		<Style Selector="Button.primary:disabled /template/ ContentPresenter#PART_ContentPresenter">
			<Setter Property="TextBlock.Foreground" Value="#888888"/>
		</Style>

		<!-- Secondary Button Style -->
		<Style Selector="Button.secondary">
			<Setter Property="Background" Value="#6C757D"/>
			<Setter Property="Foreground" Value="White"/>
			<Setter Property="FontWeight" Value="Medium"/>
			<Setter Property="CornerRadius" Value="6"/>
			<Setter Property="Padding" Value="18,12"/>
			<Setter Property="BorderThickness" Value="0"/>
			<Setter Property="BorderBrush" Value="Transparent"/>
			<Setter Property="FontSize" Value="14"/>
			<Setter Property="IsVisible" Value="True"/>
			<Setter Property="Template">
				<ControlTemplate>
					<Border Name="PART_Border"
							Background="{TemplateBinding Background}"
							CornerRadius="{TemplateBinding CornerRadius}"
							Padding="{TemplateBinding Padding}"
							BorderThickness="0"
							BorderBrush="Transparent">
						<ContentPresenter Name="PART_ContentPresenter"
										Content="{TemplateBinding Content}"
										HorizontalAlignment="Center"
										VerticalAlignment="Center"
										TextBlock.Foreground="{TemplateBinding Foreground}"
										TextBlock.FontWeight="{TemplateBinding FontWeight}"
										TextBlock.FontSize="{TemplateBinding FontSize}"
										TextBlock.TextAlignment="Center"/>
					</Border>
				</ControlTemplate>
			</Setter>
		</Style>

		<Style Selector="Button.secondary:pointerover /template/ Border#PART_Border">
			<Setter Property="Background" Value="#545B62"/>
			<Setter Property="BorderThickness" Value="0"/>
			<Setter Property="BorderBrush" Value="Transparent"/>
		</Style>

		<Style Selector="Button.secondary:focus /template/ Border#PART_Border">
			<Setter Property="BorderThickness" Value="0"/>
			<Setter Property="BorderBrush" Value="Transparent"/>
		</Style>

		<!-- CheckBox Styles with Full Template -->
		<Style Selector="CheckBox">
			<Setter Property="FontSize" Value="13"/>
			<Setter Property="Foreground" Value="#212529"/>
			<Setter Property="MinHeight" Value="32"/>
			<Setter Property="Template">
				<ControlTemplate>
					<Grid ColumnDefinitions="Auto,*">
						<Border Name="PART_Border"
								Grid.Column="0"
								Width="24"
								Height="24"
								Background="White"
								BorderBrush="#CED4DA"
								BorderThickness="2"
								CornerRadius="4"
								VerticalAlignment="Center"
								Margin="0,0,10,0">
							<Viewbox Width="16" Height="16">
								<Path Name="PART_Check"
									  IsVisible="False"
									  Stroke="#007ACC"
									  StrokeThickness="2"
									  Data="M 2,8 L 8,14 L 18,4"
									  Stretch="Uniform"/>
							</Viewbox>
						</Border>
						<ContentPresenter Grid.Column="1"
										  Content="{TemplateBinding Content}"
										  VerticalAlignment="Center"/>
					</Grid>
				</ControlTemplate>
			</Setter>
		</Style>

		<Style Selector="CheckBox:pointerover /template/ Border#PART_Border">
			<Setter Property="BorderBrush" Value="#007ACC"/>
		</Style>

		<Style Selector="CheckBox:checked /template/ Border#PART_Border">
			<Setter Property="Background" Value="#007ACC"/>
			<Setter Property="BorderBrush" Value="#007ACC"/>
		</Style>

		<Style Selector="CheckBox:checked /template/ Path#PART_Check">
			<Setter Property="IsVisible" Value="True"/>
			<Setter Property="Stroke" Value="White"/>
		</Style>

		<!-- Text Styles -->
		<Style Selector="TextBlock.content">
			<Setter Property="FontSize" Value="13"/>
			<Setter Property="Foreground" Value="#495057"/>
			<Setter Property="TextWrapping" Value="Wrap"/>
			<Setter Property="LineHeight" Value="20"/>
		</Style>

		<Style Selector="TextBlock.link">
			<Setter Property="FontSize" Value="13"/>
			<Setter Property="Foreground" Value="#007ACC"/>
			<Setter Property="Cursor" Value="Hand"/>
			<Setter Property="TextDecorations" Value="Underline"/>
		</Style>
	</Window.Styles>

	<Grid RowDefinitions="Auto,*,Auto" Margin="0" MaxHeight="750">
		<!-- Header -->
		<Border Grid.Row="0" Background="#007ACC" Padding="30,16">
			<StackPanel Spacing="3">
				<TextBlock Text="Personvern og brukervilkår"
                           FontSize="20"
                           FontWeight="Bold"
                           Foreground="White"/>
				<TextBlock Text="Vennligst les og godta våre avtaler for å fortsette"
                           FontSize="11"
                           Foreground="#E8F4FC"/>
			</StackPanel>
		</Border>

		<!-- Content -->
		<ScrollViewer Grid.Row="1"
					  VerticalScrollBarVisibility="Visible"
					  HorizontalScrollBarVisibility="Disabled"
					  Padding="20,15,20,15">
			<!-- WRAP EVERYTHING IN A GRID -->
			<Grid>
				<!-- Loading Indicator -->
				<TextBlock Text="Laster inn..."
						   FontSize="14"
						   Foreground="#6C757D"
						   HorizontalAlignment="Center"
						   VerticalAlignment="Center"
						   Margin="0,50"
						   IsVisible="{Binding IsLoading}"/>

				<!-- Actual Content - Only show when loaded -->
				<StackPanel Spacing="16" IsVisible="{Binding IsContentReady}">

					<!-- Privacy Policy Upgrade Changelog (only visible for existing users with outdated privacy) -->
					<Border Background="#FFF4E5"
							BorderBrush="#FF9800"
							BorderThickness="2"
							CornerRadius="8"
							Padding="16"
							IsVisible="{Binding IsPrivacyUpgrade}"
							Margin="0,0,5,0">
						<StackPanel Spacing="10">
							<StackPanel Orientation="Horizontal" Spacing="8">
								<TextBlock Text="🔔"
										   FontSize="18"
										   VerticalAlignment="Center"/>
								<TextBlock Text="Oppdatert personvernserklæring"
										   FontWeight="Bold"
										   FontSize="15"
										   Foreground="#E65100"
										   VerticalAlignment="Center"/>
							</StackPanel>

							<TextBlock TextWrapping="Wrap"
									   FontSize="12"
									   Foreground="#BF360C"
									   LineHeight="18">
								<Run>Vi har oppdatert vår personvernserklæring fra versjon </Run>
								<Run Text="{Binding UserCurrentPrivacyVersion, FallbackValue='1.0'}" FontWeight="Bold"/>
								<Run> til versjon </Run>
								<Run Text="{Binding LatestPrivacyVersion, FallbackValue='1.1'}" FontWeight="Bold"/>
								<Run>. Vennligst les endringene nedenfor og godta den nye versjonen.</Run>
							</TextBlock>

							<Separator Background="#FFB74D" Height="1" Margin="0,4"/>

							<TextBlock TextWrapping="Wrap"
									   FontSize="13"
									   Foreground="#E65100">
								<Run>Hva er nytt i versjon </Run>
								<Run Text="{Binding LatestPrivacyVersion, FallbackValue='1.1'}" FontWeight="SemiBold"/>
								<Run>:</Run>
							</TextBlock>

							<!-- Privacy Changelog bullet points -->
							<ItemsControl ItemsSource="{Binding PrivacyChangelogItems, FallbackValue={x:Null}}">
								<ItemsControl.ItemTemplate>
									<DataTemplate x:DataType="x:String">
										<StackPanel Orientation="Horizontal" Spacing="8" Margin="0,3">
											<TextBlock Text="✓"
													   FontSize="12"
													   Foreground="#43A047"
													   FontWeight="Bold"
													   VerticalAlignment="Top"
													   Margin="0,1,0,0"/>
											<TextBlock Text="{Binding}"
													   TextWrapping="Wrap"
													   FontSize="12"
													   Foreground="#4E342E"
													   LineHeight="18"/>
										</StackPanel>
									</DataTemplate>
								</ItemsControl.ItemTemplate>
							</ItemsControl>
						</StackPanel>
					</Border>

					<!-- Terms of Use Upgrade Changelog (only visible for existing users with outdated terms) -->
					<Border Background="#E3F2FD"
							BorderBrush="#2196F3"
							BorderThickness="2"
							CornerRadius="8"
							Padding="16"
							IsVisible="{Binding IsTermsUpgrade}"
							Margin="0,0,33,0">
						<StackPanel Spacing="10">
							<StackPanel Orientation="Horizontal" Spacing="8">
								<TextBlock Text="📄"
										   FontSize="18"
										   VerticalAlignment="Center"/>
								<TextBlock Text="Oppdaterte brukervilkår"
										   FontWeight="Bold"
										   FontSize="15"
										   Foreground="#0D47A1"
										   VerticalAlignment="Center"/>
							</StackPanel>

							<TextBlock TextWrapping="Wrap"
									   FontSize="12"
									   Foreground="#1565C0"
									   LineHeight="18">
								<Run>Vi har oppdatert våre brukervilkår fra versjon </Run>
								<Run Text="{Binding UserCurrentTermsVersion, FallbackValue='1.0'}" FontWeight="Bold"/>
								<Run> til versjon </Run>
								<Run Text="{Binding LatestTermsVersion, FallbackValue='1.1'}" FontWeight="Bold"/>
								<Run>. Vennligst les endringene nedenfor og godta den nye versjonen.</Run>
							</TextBlock>

							<Separator Background="#90CAF9" Height="1" Margin="0,4"/>

							<TextBlock TextWrapping="Wrap"
									   FontSize="13"
									   Foreground="#0D47A1">
								<Run>Hva er nytt i versjon </Run>
								<Run Text="{Binding LatestTermsVersion, FallbackValue='1.1'}" FontWeight="SemiBold"/>
								<Run>:</Run>
							</TextBlock>

							<!-- Terms Changelog bullet points -->
							<ItemsControl ItemsSource="{Binding TermsChangelogItems, FallbackValue={x:Null}}">
								<ItemsControl.ItemTemplate>
									<DataTemplate x:DataType="x:String">
										<StackPanel Orientation="Horizontal" Spacing="8" Margin="0,3">
											<TextBlock Text="✓"
													   FontSize="12"
													   Foreground="#43A047"
													   FontWeight="Bold"
													   VerticalAlignment="Top"
													   Margin="0,1,0,0"/>
											<TextBlock Text="{Binding}"
													   TextWrapping="Wrap"
													   FontSize="12"
													   Foreground="#1A237E"
													   LineHeight="18"/>
										</StackPanel>
									</DataTemplate>
								</ItemsControl.ItemTemplate>
							</ItemsControl>
						</StackPanel>
					</Border>

					<!-- Section: Personvernserklæring (only show if needs consent) -->
					<StackPanel Spacing="8" IsVisible="{Binding NeedsPrivacyConsent}">
						<TextBlock Text="📜 Personvernserklæring"
								   FontSize="15"
								   FontWeight="Bold"
								   Foreground="#212529"/>

						<TextBlock Text="Les vår fullstendige personvernserklæring:"
								   Classes="content"
								   FontSize="13"/>
						<TextBlock Text="https://cybergutta.github.io/AkademietTrack/privacy-policy.html"
								   Classes="link"
								   FontSize="12"
								   Tapped="OnPrivacyPolicyLinkTapped"
								   Name="PrivacyLink"/>

						<StackPanel Spacing="4" Margin="0,6,0,0">
							<TextBlock Text="Sammendrag av databehandling:"
									   FontSize="13"
									   FontWeight="SemiBold"
									   Foreground="#212529"/>

							<TextBlock Classes="content" FontSize="12" LineHeight="18">
								• Vi lagrer dine Feide-innloggingsopplysninger kryptert lokalt på din enhet
							</TextBlock>
							<TextBlock Classes="content" FontSize="12" LineHeight="18">
								• Vi bruker disse opplysningene kun for automatisk fremmøteregistrering
							</TextBlock>
							<TextBlock Classes="content" FontSize="12" LineHeight="18">
								• Din aktiveringsnøkkel og e-post lagres i vår database
							</TextBlock>
							<TextBlock Classes="content" FontSize="12" LineHeight="18">
								• Vi deler ikke dine personopplysninger med tredjeparter
							</TextBlock>
						</StackPanel>
					</StackPanel>

					<!-- Separator - only show if BOTH sections are visible -->
					<Separator Background="#DEE2E6" Height="1" Margin="0,4"
							   IsVisible="{Binding ShowBothSections}"/>

					<!-- Section: Brukervilkår (only show if needs consent) -->
					<StackPanel Spacing="8" IsVisible="{Binding NeedsTermsConsent}">
						<TextBlock Text="📋 Brukervilkår"
								   FontSize="15"
								   FontWeight="Bold"
								   Foreground="#212529"/>

						<TextBlock Text="Les våre fullstendige brukervilkår:"
								   Classes="content"
								   FontSize="13"/>
						<TextBlock Text="https://cybergutta.github.io/AkademietTrack/terms-of-use.html"
								   Classes="link"
								   FontSize="12"
								   Tapped="OnTermsOfUseLinkTapped"
								   Name="TermsLink"/>

						<StackPanel Spacing="4" Margin="0,6,0,0">
							<TextBlock Text="Viktige punkter:"
									   FontSize="13"
									   FontWeight="SemiBold"
									   Foreground="#212529"/>

							<TextBlock Classes="content" FontSize="12" LineHeight="18">
								• Du er ansvarlig for å holde dine innloggingsopplysninger sikre
							</TextBlock>
							<TextBlock Classes="content" FontSize="12" LineHeight="18">
								• Tjenesten leveres "som den er" uten garantier
							</TextBlock>
							<TextBlock Classes="content" FontSize="12" LineHeight="18">
								• Du må følge alle gjeldende lover og regler ved bruk av tjenesten
							</TextBlock>
							<TextBlock Classes="content" FontSize="12" LineHeight="18">
								• Vi forbeholder oss retten til å endre tjenesten eller vilkårene
							</TextBlock>
						</StackPanel>
					</StackPanel>

					<!-- Consent Checkboxes -->
					<StackPanel Spacing="12" Margin="0,8,0,55">
						<!-- Privacy Policy Checkbox - ONLY if needs privacy consent -->
						<Border Background="#F8F9FA"
								BorderBrush="#FF9800"
								BorderThickness="2"
								CornerRadius="6"
								Padding="14"
								IsVisible="{Binding NeedsPrivacyConsent}">
							<CheckBox IsChecked="{Binding HasAcceptedPrivacy}">
								<TextBlock Text="Jeg har lest og godtar personvernserklæringen"
										   FontSize="13"
										   Foreground="#212529"
										   FontWeight="Medium"
										   TextWrapping="Wrap"/>
							</CheckBox>
						</Border>

						<!-- Terms of Use Checkbox - ONLY if needs terms consent -->
						<Border Background="#F8F9FA"
								BorderBrush="#2196F3"
								BorderThickness="2"
								CornerRadius="6"
								Padding="14"
								IsVisible="{Binding NeedsTermsConsent}">
							<CheckBox IsChecked="{Binding HasAcceptedTerms}">
								<TextBlock Text="Jeg har lest og godtar brukervilkårene"
										   FontSize="13"
										   Foreground="#212529"
										   FontWeight="Medium"
										   TextWrapping="Wrap"/>
							</CheckBox>
						</Border>
					</StackPanel>

					<!-- Error Message -->
					<TextBlock Text="{Binding ErrorMessage}"
							   Foreground="#DC3545"
							   FontSize="12"
							   IsVisible="{Binding HasError}"
							   TextWrapping="Wrap"
							   Margin="0,0,0,10"/>

				</StackPanel>
			</Grid>
		</ScrollViewer>

		<!-- Footer (ALWAYS VISIBLE) -->
		<Border Grid.Row="2"
                Background="White"
                BorderBrush="#DEE2E6"
                BorderThickness="0,2,0,0"
                Padding="20,18"
                BoxShadow="0 -2 8 0 #10000000">
			<Grid ColumnDefinitions="*,Auto">

				<!-- Exit Button -->
				<Button Grid.Column="0"
                        Content="Avslutt"
                        Command="{Binding ExitCommand}"
                        Classes="secondary"
                        HorizontalAlignment="Left"/>

				<!-- Accept Button -->
				<Button Grid.Column="1"
                        Content="{Binding AcceptButtonText}"
                        Command="{Binding AcceptCommand}"
                        IsEnabled="{Binding CanAccept}"
                        Classes="primary"/>
			</Grid>
		</Border>
	</Grid>
</Window>